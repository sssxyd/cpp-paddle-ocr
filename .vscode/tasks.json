{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "build-ocr-server",  
      "type": "shell",
      "command": "cl.exe",
      "args": [
        "/std:c++20",
        "/utf-8",
        "/EHsc",
        "/TP",
        "/MT",               // 改为 Release 静态运行时库
        "/W3",
        "/O2",               // Release 优化
        "/Zi",              // 调试信息        
        "/DNDEBUG",          // Release 宏定义
        "/DWIN32",          // 定义 Windows 平台
        "/D_WINDOWS",                 // Windows 平台
        "/D_CRT_SECURE_NO_WARNINGS",  // 禁用安全警告
        "/DBASE64_STATIC_DEFINE",     // 定义 Base64 静态库宏
          // 编译 src 目录下的所有源文件（main.cpp放在第一位）
        "src/ocr_service_main.cpp",
        "src/ocr_service.cpp",
        "src/ocr_worker.cpp",
        "src/gpu_worker_pool.cpp",
        "src/cpu_worker_pool.cpp",
        "src/ocr_ipc_service.cpp",
        "src/ocr_ipc_client.cpp",
        "src/clipper.cpp",
        "src/ocr_cls.cpp", 
        "src/ocr_det.cpp",
        "src/ocr_rec.cpp",
        "src/postprocess_op.cpp",
        "src/preprocess_op.cpp",
        "src/utility.cpp",

        // 头文件路径
        "/I", "${workspaceFolder}/include",
        "/I", "${env:MSVC_INCLUDE}",
        "/I", "${env:WIN_SDK_INCLUDE}/ucrt",
        "/I", "${env:WIN_SDK_INCLUDE}/shared",
        "/I", "${env:WIN_SDK_INCLUDE}/um",        
        "/I", "${env:VCPKG_STATIC}/include",       
        "/I", "${env:VCPKG_STATIC}/include/opencv4",      

        "/Fe:${workspaceFolder}\\build\\ocr-service.exe",   // 指定输出文件名
        "/Fo:${workspaceFolder}\\build\\",          // 指定对象文件输出目录
        "/Fd:${workspaceFolder}\\build\\ocr-service.pdb",    // 指定编译器PDB文件
        
        "/link",
        "/DEBUG",            // 生成调试信息
        "/PDB:${workspaceFolder}\\build\\ocr-service.pdb",  // 指定链接器PDB文件位置
        "/ILK:${workspaceFolder}\\build\\ocr-service.ilk",  // 指定增量链接文件位置
        // 排除 Debug 运行时库
        "/NODEFAULTLIB:msvcprtd.lib",
        "/NODEFAULTLIB:msvcrtd.lib",
        "/NODEFAULTLIB:libcmtd.lib",
        
        // 库文件路径（使用 Release 路径）
        "/LIBPATH:${env:MSVC_LIB}",
        "/LIBPATH:${env:WIN_SDK_LIB}/ucrt/x64",
        "/LIBPATH:${env:WIN_SDK_LIB}/um/x64",
        "/LIBPATH:${env:VCPKG_STATIC}/lib",  
        "/LIBPATH:${workspaceFolder}/lib/msvc",
        
        // 主要库
        "paddle_inference.lib",
        
        // OpenCV 库（Release 版本，去掉 'd' 后缀）
        "opencv_highgui4.lib",
        "opencv_imgcodecs4.lib",
        "opencv_imgproc4.lib",
        "opencv_core4.lib",
        
        // 日志库（Release 版本）        "glog.lib",
        "gflags_static.lib",

        "jsoncpp.lib",           // JSON 库
        "base64.lib",            // Base64 编码/解码库 (aklomp-base64)
        
        // 图像格式库（Release 版本）
        "libwebp.lib",
        "libwebpdemux.lib",
        "libwebpmux.lib",
        "libwebpdecoder.lib",
        "libsharpyuv.lib",
        
        // 压缩库（Release 版本）
        "zlib.lib",
        "libpng16.lib",
        "tiff.lib",
        "lzma.lib",
        "turbojpeg.lib",       // 或 jpeg.lib
        
        // Windows 系统库
        "kernel32.lib",
        "user32.lib",
        "gdi32.lib",
        "advapi32.lib",
        "shell32.lib",
        "ole32.lib",
        "oleaut32.lib",
        "uuid.lib",        
        "comdlg32.lib",        
        "shlwapi.lib",        // 用于 gflags PathMatchSpecA 函数
      ],
      "options": {
        "cwd": "${workspaceFolder}"
      },
      "group": {
        "kind": "build",
        "isDefault": true
      },
      "presentation": {
        "echo": true,
        "reveal": "always",
        "focus": false,
        "panel": "shared"
      },      
      "problemMatcher": ["$msCompile"],
      "dependsOrder": "sequence",
      "dependsOn": ["copy-build-dependencies"]
    },    
    {
      "label": "copy-build-dependencies",
      "type": "shell",
      "command": "powershell",
      "args": [        
        "-ExecutionPolicy", "Bypass",
        "-Command",
        "Write-Host 'Copying dependencies to build directory...'; if (!(Test-Path 'build')) { New-Item -ItemType Directory -Path 'build' -Force | Out-Null }; if (Test-Path 'bin\\msvc\\*.dll') { Copy-Item -Path 'bin\\msvc\\*.dll' -Destination 'build\\' -Force; Write-Host 'DLL files from bin/msvc copied successfully' } else { Write-Host 'No DLL files found in bin/msvc' }; if (Test-Path 'C:\\Windows\\System32\\vcomp140.dll') { Copy-Item -Path 'C:\\Windows\\System32\\vcomp140.dll' -Destination 'build\\' -Force; Write-Host 'vcomp140.dll copied successfully' } else { Write-Host 'vcomp140.dll not found in System32' }; if (Test-Path 'models') { if (!(Test-Path 'build\\models')) { Copy-Item -Path 'models' -Destination 'build\\' -Recurse -Force; Write-Host 'Models directory copied successfully' } else { Write-Host 'Models directory already exists, skipping copy' } } else { Write-Host 'Models directory not found' }; Write-Host 'Dependencies copy completed!'"
      ],
      "group": "build",
      "presentation": {
        "echo": true,
        "reveal": "always",
        "focus": false,
        "panel": "shared"
      }
    },
    {
      "label": "build-ocr-client",
      "type": "shell",
      "command": "cl.exe", 
      "args": [
        "/std:c++20",
        "/utf-8",
        "/EHsc",
        "/TP",
        "/MT",
        "/W3",
        "/O2",
        "/Zi",        "/DNDEBUG",
        "/DWIN32",
        "/D_WINDOWS", 
        "/D_CRT_SECURE_NO_WARNINGS",
        "/DBASE64_STATIC_DEFINE",     // 定义 Base64 静态库宏
        // OCR Client 源文件（仅客户端相关）
        "src/ocr_client_main.cpp",
        "src/ocr_ipc_client.cpp",
        
        // 头文件路径
        "/I", "${workspaceFolder}/include",
        "/I", "${env:MSVC_INCLUDE}", 
        "/I", "${env:WIN_SDK_INCLUDE}/ucrt",
        "/I", "${env:WIN_SDK_INCLUDE}/shared",
        "/I", "${env:WIN_SDK_INCLUDE}/um",
        "/I", "${env:VCPKG_STATIC}/include",

        "/Fe:${workspaceFolder}\\build\\client\\ocr-client.exe",
        "/Fo:${workspaceFolder}\\build\\client\\",
        "/Fd:${workspaceFolder}\\build\\client\\ocr-client.pdb",
        
        "/link",
        "/DEBUG",
        "/PDB:${workspaceFolder}\\build\\client\\ocr-client.pdb",  // 指定链接器PDB文件位置
        "/ILK:${workspaceFolder}\\build\\client\\ocr-client.ilk",  // 指定增量链接文件位置        
        "/NODEFAULTLIB:msvcprtd.lib",
        "/NODEFAULTLIB:msvcrtd.lib",
        "/NODEFAULTLIB:libcmtd.lib", 
        "/LIBPATH:${env:MSVC_LIB}",
        "/LIBPATH:${env:WIN_SDK_LIB}/ucrt/x64",
        "/LIBPATH:${env:WIN_SDK_LIB}/um/x64",
        "/LIBPATH:${env:VCPKG_STATIC}/lib",
        "jsoncpp.lib",           // JSON 解析
        "base64.lib",         // Base64 编码/解码
        "kernel32.lib",          // Windows API
        "user32.lib",
        "advapi32.lib",
        "ole32.lib",
        "oleaut32.lib",
        "uuid.lib"
      ],      "options": {
        "cwd": "${workspaceFolder}"
      },
      "group": "build"
    },      {
      "label": "build-ocr-tests",
      "type": "shell",
      "command": "powershell",
      "args": [
        "-ExecutionPolicy",
        "Bypass",        "-File",
        "${workspaceFolder}\\tests\\build_tests.bat"
      ],      "options": {
        "cwd": "${workspaceFolder}\\tests"
      },
      "group": "build",
      "problemMatcher": "$msCompile"
    },
    {
      "label": "build-ocr-tests-debug",
      "type": "shell",
      "command": "cl.exe",
      "args": [
        "/std:c++20",
        "/utf-8",
        "/EHsc",
        "/TP",
        "/MTd",              // Debug 静态运行时库
        "/W3",
        "/Od",               // Debug 优化关闭
        "/Zi",               // 调试信息
        "/DEBUG",            // Debug 宏定义
        "/DWIN32",
        "/D_WINDOWS",
        "/D_CRT_SECURE_NO_WARNINGS",
        "/DBASE64_STATIC_DEFINE",
        "${workspaceFolder}\\tests\\test_ocr_worker.cpp",
        "${workspaceFolder}\\src\\ocr_worker.cpp",
        "${workspaceFolder}\\src\\ocr_det.cpp",
        "${workspaceFolder}\\src\\ocr_rec.cpp",
        "${workspaceFolder}\\src\\ocr_cls.cpp",
        "${workspaceFolder}\\src\\clipper.cpp",
        "${workspaceFolder}\\src\\postprocess_op.cpp",
        "${workspaceFolder}\\src\\preprocess_op.cpp",
        "${workspaceFolder}\\src\\utility.cpp",
        "/I",
        "${workspaceFolder}\\include",
        "/I",
        "${env:MSVC_INCLUDE}",
        "/I",
        "${env:WIN_SDK_INCLUDE}\\ucrt",
        "/I",
        "${env:WIN_SDK_INCLUDE}\\shared",
        "/I",
        "${env:WIN_SDK_INCLUDE}\\um",
        "/I",
        "${env:VCPKG_STATIC}\\include",
        "/I",
        "${env:VCPKG_STATIC}\\include\\opencv4",        "/Fe:${workspaceFolder}\\tests\\build\\test_ocr_worker_debug.exe",
        "/Fo:${workspaceFolder}\\tests\\build\\",
        "/Fd:${workspaceFolder}\\tests\\build\\test_ocr_worker_debug.pdb",
        "/link",
        "/DEBUG",
        "/PDB:${workspaceFolder}\\tests\\build\\test_ocr_worker_debug.pdb",
        "/LIBPATH:${env:MSVC_LIB}",
        "/LIBPATH:${env:WIN_SDK_LIB}\\ucrt\\x64",
        "/LIBPATH:${env:WIN_SDK_LIB}\\um\\x64",
        "/LIBPATH:${env:VCPKG_STATIC}\\lib",
        "/LIBPATH:${workspaceFolder}\\lib\\msvc",
        "paddle_inference.lib",
        "opencv_highgui4.lib",
        "opencv_imgcodecs4.lib",
        "opencv_imgproc4.lib",
        "opencv_core4.lib",
        "gflags_static.lib",
        "jsoncpp.lib",
        "base64.lib",
        "kernel32.lib",
        "user32.lib",
        "gdi32.lib",
        "advapi32.lib",
        "shell32.lib",
        "ole32.lib",
        "oleaut32.lib",
        "uuid.lib",
        "comdlg32.lib",
        "shlwapi.lib"
      ],
      "options": {
        "cwd": "${workspaceFolder}"
      },
      "group": "build",
      "dependsOn": "copy-build-dependencies",
      "problemMatcher": "$msCompile"
    },
    {
      "label": "run-ocr-tests",
      "type": "shell",
      "command": "${workspaceFolder}\\tests\\build\\test_ocr_worker.exe",
      "options": {
        "cwd": "${workspaceFolder}\\tests\\build"
      },
      "group": "test",
      "dependsOn": "build-ocr-tests"
    },
    {
      "label": "clean-test-build",
      "type": "shell",
      "command": "powershell",
      "args": [
        "-ExecutionPolicy",
        "Bypass",
        "-Command",
        "if (Test-Path '${workspaceFolder}\\tests\\build') { Remove-Item -Recurse -Force '${workspaceFolder}\\tests\\build'; Write-Host 'Test build directory cleaned' } else { Write-Host 'Test build directory does not exist' }"
      ],
      "options": {
        "cwd": "${workspaceFolder}"
      },
      "group": "build"
    }
  ]
}